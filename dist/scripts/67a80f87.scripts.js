"use strict";var app=angular.module("remixApp",["ui.router"]);app.config(["$urlRouterProvider","$locationProvider","$stateProvider",function(a,b,c){a.when("","/").otherwise("/"),c.state("app",{url:"/","abstract":!0,views:{"":{templateUrl:"views/nav.html",controller:"NavCtrl"}}}).state("app.home",{url:"",views:{"":{templateUrl:"views/home.html",controller:"HomeCtrl"}}}).state("app.playlists",{url:"playlists",views:{"":{templateUrl:"views/playlists.list.html",controller:"PlaylistsCtrl"}},resolve:{playlists:"playlists"}}).state("app.song",{url:"s/{id}",views:{"":{templateUrl:"views/song.html",controller:"SongCtrl"}},resolve:{songData:["$stateParams","songData",function(a,b){return b.get(a.id)}]}}).state("app.playlist",{url:"p/{id}",views:{"":{templateUrl:"views/playlist.html",controller:"PlaylistCtrl"}},resolve:{playlist:["$stateParams","playlist",function(a,b){return b.get(a.id)}]}})}]).run(["Rdio","$rootScope",function(a,b){R.ready(function(){b.user=a.currentUser(),b.$apply()})}]).run(["$rootScope","Alert",function(a,b){a.$on("$stateChangeStart",function(){b.info("Loading...")}),a.$on("$stateChangeSuccess",function(){$(document.body).removeClass("bootstrappin"),b.clear()}),a.$on("$stateChangeError",function(){b.error("Error, please refresh and try again")})}]),app.factory("Alert",["$rootScope","$timeout",function(a,b){var c=function(c,d,e){a.alert=!0,a.alertType="alert-"+c,a.alertMessage=d,e&&b(function(){h()},e)},d=function(a){c("danger",a)},e=function(a){c("info",a)},f=function(a){c("success",a)},g=function(a){c("warning",a)},h=function(){a.alert=!1};return{error:d,info:e,success:f,warning:g,clear:h}}]),app.factory("Player",["$q","$rootScope","SoundCloud","Alert",function(a,b,c,d){var e=0,f=null,g=null,h=null,i=function(){h&&(h.then(null),h=null,b.sound&&b.sound.stop())},j=function(){i(),g=f[e],d.info("Buffering..."),h=c.stream(g.mix),h.then(function(a){d.clear(),a&&(b.track=g,b.sound=a,a.play({whileplaying:_.throttle(function(){b.$apply()},500),onfinish:function(){l()}}))})},k=function(a){var b=[],e=!1;d.info("Remixin'...");var f=function(a){_.isEmpty(a)||c.remix(a[0]).then(function(c){_.isEmpty(c)||(e?(_.each(c,function(c){b.push({original:a[0],mix:c})}),n(b)):(b.push({original:a[0],mix:c[Math.floor(Math.random()*c.length)]}),1==b.length&&n(b))),a.shift(),f(a)})};i(),_.isArray(a)?a=_.clone(a):(a=[a],e=!0),f(a)},l=function(){e=(e+1)%f.length,j()},m=function(){e=(e+f.length-1)%f.length,j()},n=function(a){f=a,e=0,j()},o=function(a,b){_.isArray(a)||(a=[a]),a[0].mix||(a=_.map(a,function(a){return{mix:a,original:b}})),n(a)},p=function(){return b.sound?1===b.sound.playState&&!b.sound.paused:!1},q=function(){b.sound&&b.sound.togglePause()},r=function(){return f},s=function(){return b.sound?b.sound.position/b.sound.durationEstimate:0};return{queue:o,lookupAndPlay:k,next:l,prev:m,isPlaying:p,togglePlay:q,getTracks:r,percentComplete:s}}]),app.factory("Rdio",["$q","$rootScope",function(a,b){var c=function(){var c=a.defer();return R.authenticated()?(c.resolve(R.currentUser.attributes),b.$apply()):R.authenticate(function(a){a?c.resolve(R.currentUser.attributes):deferred.reject(),b.$apply()}),c.promise},d=function(){return R.authenticated()?R.currentUser.attributes:void 0},e=function(){return R.player.playingTrack()?R.player.playingTrack().attributes:void 0},f=function(c){var d=a.defer();return R.request({method:"get",content:{keys:[c]},success:function(a){d.resolve(a.result[c]),b.$apply()},error:function(a){console.error(a),d.reject("ERRRRR"),b.$apply()}}),d.promise},g=function(){var c=a.defer();return R.request({method:"getPlaylists",content:{extras:"tracks,Track.playCount"},success:function(a){c.resolve(a.result),b.$apply()},error:function(a){console.error(a),c.reject("ERRRRR"),b.$apply()}}),c.promise},h=function(c){var d=a.defer();return R.request({method:"get",content:{keys:[c],type:"Playlist",extras:"tracks,Track.playCount"},success:function(a){d.resolve(a.result[c]),b.$apply()},error:function(a){console.error(a),d.reject("ERRRRR"),b.$apply()}}),d.promise};return{auth:c,currentUser:d,currentTrack:e,getSong:f,getPlaylists:g,getPlaylist:h}}]),app.factory("SoundCloud",["$q","$rootScope",function(a,b){var c=function(a){return _.filter(a,function(a){return a.streamable})},d=function(d){var e=a.defer();return SC.get("/tracks",{q:d.albumArtist+" "+d.name+" remix",filter:"streamable",order:"hotness",limit:50},function(a){e.resolve(c(a)),b.$apply()}),e.promise},e=function(c){var d=a.defer();return SC.stream("/tracks/"+c.id,function(a){d.resolve(a),b.$$phase||b.$apply()}),d.promise};return{remix:d,stream:e}}]),app.controller("PlayerCtrl",["$scope","$filter","Player",function(a,b,c){var d=62.5,e=8.5,f=d,g=a.radius=55,h=e+g;a.isPlaying=c.isPlaying,a.next=c.next,a.prev=c.prev,a.togglePlay=c.togglePlay,a.x1=d,a.y1=e,a.x2=f,a.y2=h,a.$watch("sound.position",_.throttle(function(){a.percent=c.percentComplete(),a.percent||(a.percent=0);var b=a.percent<=.5?a.percent:.5,d=a.percent>.5?a.percent:.5,e=360*b+270,f=360*d+90;a.x1=62.5+a.radius*Math.cos(e*(Math.PI/180)),a.y1=63.5+a.radius*Math.sin(e*(Math.PI/180)),a.x2=62.5-a.radius*Math.cos(f*(Math.PI/180)),a.y2=63.5-a.radius*Math.sin(f*(Math.PI/180))},500))}]),app.controller("NavCtrl",["$scope","$rootScope","$state","Rdio","Alert",function(a,b,c,d,e){a.signIn=function(){e.info("Logging in..."),d.auth().then(function(a){e.clear(),b.user=a,c.transitionTo("app.playlists")},function(){e.error("Unexpected error, please refresh the page and try again...")})}}]),app.controller("HomeCtrl",["$scope",function(){}]),app.controller("SongCtrl",["$scope","$stateParams","songData","Player",function(a,b,c,d){a.song=c.song,a.tracks=c.tracks,a.playAll=function(){d.queue(c.tracks,c.song)},a.playTrack=function(a){d.queue(a,c.song)}}]).factory("songData",["$q","Rdio","SoundCloud",function(a,b,c){return{get:function(d){var e=a.defer();return b.getSong(d).then(function(a){var b={song:a};a?c.remix(a).then(function(a){b.tracks=a,e.resolve(b)}):e.reject("Song not found")}),e.promise}}}]),app.controller("PlaylistsCtrl",["$scope","playlists","Player",function(a,b,c){a.playlists=b.owned.concat(b.subscribed,b.collab),a.queue=function(a){c.lookupAndPlay(a.tracks)}}]).factory("playlists",["Rdio",function(a){return a.getPlaylists()}]),app.controller("PlaylistCtrl",["$scope","$stateParams","playlist","Player",function(a,b,c,d){a.playlist=c,a.playPlaylist=function(){d.lookupAndPlay(a.playlist.tracks)},a.playTrack=function(a){d.lookupAndPlay(a)}}]).factory("playlist",["Rdio",function(a){return{get:function(b){return a.getPlaylist(b)}}}]);